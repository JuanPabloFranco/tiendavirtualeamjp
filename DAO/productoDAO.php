<?phpsession_start();include '../Conexion/consulSQL.php';sleep(1);if ($_POST['funcion'] <> "") { // Verificar si la variable con el tipo de proceso es diferente de vacio    // Se verifica el valor de la variable POST, cuando es igual al deseado realiza el proceso correspondiente    // Se obtienen los datos del formulario html por variables POST    if ($_POST['funcion'] == "crearProducto") {        ?>        <html>            <head>                <title>Admin</title>                <meta charset="UTF-8">                <meta http-equiv="Refresh" content="4;url=../index.php?page=configAdmin">                <meta name="viewport" content="width=device-width, initial-scale=1">                <link rel="stylesheet" href="../Recursos/css/font-awesome.min.css">                <link rel="stylesheet" href="../Recursos/css/normalize.css">                <link rel="stylesheet" href="../Recursos/css/bootstrap.min.css">                <link rel="stylesheet" href="../Recursos/css/style.css">                <link rel="stylesheet" href="../Recursos/css/media.css">                <link rel="Shortcut Icon" type="image/x-icon" href="../Recursos/assets/icons/logo.ico" />                <script src="../Recursos/js/jquery.min.js"></script>                <script src="../Recursos/js/bootstrap.min.js"></script>                <script src="../Recursos/js/autohidingnavbar.min.js"></script>            </head>            <body>                <section>                    <div class="container">                        <div class="row">                            <div class="col-xs-12 col-md-6 col-md-offset-3 text-center">                                <?php                                $codigo_prod = $_POST['codigo_prod'];                                $nombre_prod = $_POST['nombre_prod'];                                $id_categoria = $_POST['id_categoria'];                                $precio = $_POST['precio'];                                $marca = $_POST['marca'];                                $id_proveedor = $_POST['id_proveedor'];                                $id_admin = $_POST['id_admin'];                                $descripcion_prod = $_POST['descripcion_prod'];                                $estadoProd = 'Disponible';                                //Se verifica que las variables a guardar no esten vacias                                if (!$codigo_prod == "" && !$nombre_prod == "" && !$id_categoria == "" && !$precio == "" && !$_FILES['img']['name'] == "" && !$marca == "" && !$id_proveedor == "" && !$id_admin == "" && !$descripcion_prod == "") {                                    // Se verifica si existe un producto con el codigo ingresado en bd                                    $verificar = ejecutarSQL::consultar("SELECT * FROM producto WHERE codigo_prod='" . $codigo_prod . "'");                                    $verificaltotal = mysqli_num_rows($verificar);                                    if ($verificaltotal <= 0) {                                         // Se guarda la foto del producto en la carpeta repositorio                                        if (move_uploaded_file($_FILES['img']['tmp_name'], "../Recursos/img-products/" . $_FILES['img']['name'])) { // si es exitoso el guardado continua el proceso                                            // se realiza la consulta de registro del producto                                            $sqlReg = "INSERT INTO producto (codigo_prod, nombre_prod, precio, marca, imagen, id_categoria, id_proveedor, id_admin, descripcion_prod, estado_prod) VALUES "                                                    . "('" . $codigo_prod . "','" . $nombre_prod . "'," . $precio . ",'" . $marca . "','" . $_FILES['img']['name'] . "'," . $id_categoria . "," . $id_proveedor . "," . $id_admin . ",'" . $descripcion_prod . "','Disponible')";                                            $resultado = ejecutarSQL::consultar($sqlReg);                                            if ($resultado) {                                                ?>                                                <img src="../Recursos/img/correctofull.png" style="width: 50%" class="center-all-contens">                                                <br>                                                <h3>El producto se añadio a la tienda con éxito</h3>                                                                                                <?php                                            } else {                                                echo $sqlReg;                                            }                                        } else {                                            ?>                                            <img src="../Recursos/img/incorrectofull.png" style="width: 50%" class="center-all-contens">                                            <br>                                            <h3>Ha ocurrido un error. Por favor intente nuevamente</h3>                                            <p class="lead text-cente">                                                La pagina se redireccionara automaticamente. Si no es asi haga click en el siguiente boton.<br>                                                <a href="index.php?page=configAdmin" class="btn btn-primary btn-lg">Volver a administración</a>                                            </p>                                            <?php                                        }                                    } else {                                        ?>                                        <img src="../Recursos/img/incorrectofull.png" style="width: 50%" class="center-all-contens">                                        <br>                                        <h3>El Código de producto ya esta registrado.<br>Por favor ingrese otro código de producto</h3>                                        <p class="lead text-cente">                                            La pagina se redireccionara automaticamente. Si no es asi haga click en el siguiente boton.<br>                                            <a href="index.php?page=configAdmin" class="btn btn-primary btn-lg">Volver a administración</a>                                        </p>                                        <?php                                    }                                } else {                                    ?>                                    <img src="../Recursos/img/incorrectofull.png" style="width: 50%" class="center-all-contens">                                    <br>                                    <h3>Error los campos no deben de estar vacíos</h3>                                    <p class="lead text-cente">                                        La pagina se redireccionara automaticamente. Si no es asi haga click en el siguiente boton.<br>                                        <a href="../Vista/configAdmin.php" class="btn btn-primary btn-lg">Volver a administración</a>                                    </p>                                    <?php                                }                                ?>                            </div>                        </div>                    </div>                </section>            </body>        </html>        <?php    }    if ($_POST['funcion'] == "actualizarProducto") {        // Se obtienen los datos del formulario html por variables POST        $id = $_POST['id'];                $codigo_prod = $_POST['codigo_prod'];        $nombre_prod = $_POST['nombre_prod'];        $precio = $_POST['precio'];        $marca = $_POST['marca'];        $id_categoria = $_POST['id_categoria'];        $id_proveedor = $_POST['id_proveedor'];        $descripcion_prod = $_POST['descripcion_prod'];        //Se verifica que las variables a guardar no esten vacias        if ($codigo_prod <> "" && $nombre_prod <> "" && $precio <> "" && $id_categoria <> "0" && $id_proveedor <> "0") {            //Se actualiza el producto en bd            $sql = "UPDATE producto SET codigo_prod='" . $codigo_prod . "', nombre_prod='" . $nombre_prod . "', precio=" . $precio . ", marca='" . $marca . "', id_categoria=" . $id_categoria . ", id_proveedor=" . $id_proveedor . ",descripcion_prod='" . $descripcion_prod . "' WHERE id=" . $id;            $result = ejecutarSQL::consultar($sql);            if ($result) {                ?>                <br>                <img class="center-all-contens" src="Recursos/img/Check.png">                <p><strong>Actualizado</strong></p>                <?php            } else {                ?>                <br>                <img class="center-all-contens" src="Recursos/img/cancel.png">                 <p><strong>Error</strong></p>                <?php            }        } else {            ?>            <br>            <img class="center-all-contens" src="Recursos/img/cancel.png">             <p><strong>Campos obligatorios vacios</strong></p>            <?php        }    }    if ($_POST['funcion'] == "changeProducto") {        // Se obtienen el id del formulario html por variable POST        $id = $_POST['id'];        // Se obtiene el estado actual del producto        $sql = "SELECT estado_prod FROM producto WHERE id=" . $id;        $vec = mysqli_fetch_row(ejecutarSQL::consultar($sql));        if (isset($vec[0]) && $vec[0] <> "") {            //Se actualiza el estado segun el caso            if ($vec[0] == "Disponible") {                $sqlAc = "UPDATE producto SET estado_prod='No disponible' WHERE id=" . $id;            } else {                $sqlAc = "UPDATE producto SET estado_prod='Disponible' WHERE id=" . $id;            }            $result = ejecutarSQL::consultar($sqlAc);            if ($result) {                echo '<img src="Recursos/img/correcto.png" style="width: 20%" class="center-all-contens"><br><p class="lead text-center">El producto se actualizó exitosamente</p>';            } else {                echo '<img src="Recursos/img/incorrecto.png"  style="width: 20%" class="center-all-contens"><br><p class="lead text-center">Ha ocurrido un error.<br>Por favor intente nuevamente</p>';            }        } else {            echo '<img src="Recursos/img/incorrecto.png" style="width: 20%" class="center-all-contens"><br><p class="lead text-center">El código del producto no existe</p>';        }    }        if ($_POST['funcion'] == "buscarProducto") {        if ($_POST['valor'] <> "") { // Se verifica que la variable POST valor (corresponde al valor a buscar), sea diferente de vacio para realizar la bsuqueda            //Consulta que busca los productos que contengan el valor y que esten disponibles            $result = ejecutarSQL::consultar("SELECT producto.id, nombre_prod, marca, precio_venta, estado_prod, imagen, cantidad, estado_prod_bodega FROM producto, bodega WHERE bodega.id_producto=producto.id AND (estado_prod_bodega='Disponible' OR estado_prod_bodega='Agotado') AND (estado_prod='Disponible') AND (producto.nombre_prod REGEXP '" . $_POST['valor'] . "' OR producto.marca REGEXP '" . $_POST['valor'] . "' OR producto.descripcion_prod REGEXP '" . $_POST['valor'] . "' OR producto.codigo_prod REGEXP '" . $_POST['valor'] . "')");                        if ($result->num_rows > 0) {                ?>                <section id="new-prod-index">                    <div class="container">                        <div class="row">                            <?php                            $nums = 1;                            while ($fila = mysqli_fetch_array($result)) {                                // Se imprime el codigo html que contiene el resultado de la busqueda                                ?>                                <div class="col-xs-12 col-sm-6 col-md-3">                                    <div class="thumbnail" style="width: 90%">                                        <!--se inserta la imagen del producto-->                                        <a onclick="modal_ver_producto(<?php echo $fila['id']; ?>)" ><img style="max-width: 70%" src="Recursos/img-products/<?php echo $fila['imagen'] ?>" data-toggle="popover" data-trigger="hover" data-content="<?php echo $fila['descripcion_prod'] ?>"></a>                                        <div class="caption">                                            <!--se inserta la información del producto-->                                            <h3><?php echo $fila['nombre_prod'] ?></h3>                                            <p><?php echo $fila['marca'] ?></p>                                            <p>$<?php echo $fila['precio_venta'] ?></p>                                            <p class="text-center">                                                <!--Boton que abre una ventana modal con el detalle del producto-->                                                <a onclick="modal_ver_producto(<?php echo $fila['id']; ?>)" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i>&nbsp; Detalles</a>&nbsp;&nbsp;                                                <?php                                                // El boton de agregar al carrito solo aparece si el usuario es un cliente o no se ha logueado                                                if (isset($_SESSION['nombreUser']) || empty($_SESSION['nombreAdmin'])) {                                                    // Se verifica el estado del producto para mostrar el boton                                                    if ($fila['estado_prod_bodega'] <> 'Agotado') {                                                        ?>                                                        <button value="<?php echo $fila['id']; ?>" class="btn btn-success btn-sm botonCarrito"><i class="fa fa-shopping-cart"></i>&nbsp; Añadir</button>                                                        <?php                                                    }                                                }                                                ?>                                            </p>                                        </div>                                    </div>                                </div>                                <?php                                if ($nums % 4 == 0) {                                    echo '<div class="clearfix"></div>';                                }                                $nums++;                            }                            ?>                          </div>                    </div>                </section>                <?php            } else {                echo '<p class="lead text-center">No se encontraron resultados para '.$_POST['valor'].'</p>';            }        } else {            echo '<img src="recursos/img/incorrecto.png" class="center-all-contens"><br><p class="lead text-center">Ingrese un valor para buscar</p>';        }    }}else{    echo '<img src="recursos/img/incorrecto.png" class="center-all-contens"><br><p class="lead text-center">Error al leer de función ejecutada</p>';}